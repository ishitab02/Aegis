/**
 * AEGIS Protocol - Exploit Simulator
 *
 * Simulates a reentrancy attack on MockProtocol by calling the agent API
 * with manipulated metrics that trigger sentinel alerts.
 *
 * Usage: npx tsx scripts/simulate-exploit.ts
 */

const AGENT_API = process.env.AGENT_API_URL ?? "http://localhost:8000";
const TS_API = process.env.API_URL ?? "http://localhost:3000";

async function sleep(ms: number) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

function log(phase: string, msg: string) {
  const ts = new Date().toISOString().split("T")[1].split(".")[0];
  console.log(`[${ts}] [${phase}] ${msg}`);
}

async function main() {
  console.log("");
  console.log("========================================================");
  console.log("  AEGIS Protocol - Exploit Simulation");
  console.log("  Scenario: Reentrancy Attack on MockProtocol");
  console.log("========================================================");
  console.log("");

  // ---- Act 1: Trigger Detection ----
  log("ACT 1", "Triggering threat detection cycle...");
  log("ACT 1", "Simulating: 25% TVL drop (reentrancy drain)");

  try {
    const detectRes = await fetch(`${TS_API}/api/v1/sentinel/detect`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        protocol_address: "0x0000000000000000000000000000000000000001",
        protocol_name: "MockProtocol",
      }),
    });
    const detection = await detectRes.json();
    log("ACT 1", `Consensus: ${detection.consensus?.final_threat_level ?? "N/A"}`);
    log(
      "ACT 1",
      `Agreement: ${((detection.consensus?.agreement_ratio ?? 0) * 100).toFixed(0)}%`
    );
    log(
      "ACT 1",
      `Action: ${detection.consensus?.action_recommended ?? "NONE"}`
    );

    if (detection.assessments) {
      for (const a of detection.assessments) {
        log("ACT 1", `  ${a.sentinel_type}: ${a.threat_level} (${(a.confidence * 100).toFixed(0)}%)`);
      }
    }
  } catch (err) {
    log("ACT 1", `Error: ${err}. Is the API running?`);
  }

  console.log("");
  log("ACT 2", "Waiting 3 seconds before forensic analysis...");
  await sleep(3000);

  // ---- Act 2: Forensic Analysis ----
  log("ACT 2", "Triggering ChainSherlock forensic analysis...");

  try {
    const forensicRes = await fetch(`${TS_API}/api/v1/forensics`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        tx_hash: "0xdeadbeef" + Math.random().toString(16).slice(2, 10),
        protocol: "MockProtocol",
        description: "Simulated reentrancy attack on MockProtocol",
      }),
    });
    const report = await forensicRes.json();
    log("ACT 2", `Report ID: ${report.report_id ?? "N/A"}`);
    log(
      "ACT 2",
      `Attack Type: ${report.attack_classification?.primary_type ?? "PENDING"}`
    );
    log(
      "ACT 2",
      `Confidence: ${((report.attack_classification?.confidence ?? 0) * 100).toFixed(0)}%`
    );
  } catch (err) {
    log("ACT 2", `Error: ${err}. Is the API running?`);
  }

  console.log("");
  log("ACT 3", "Waiting 2 seconds for recovery simulation...");
  await sleep(2000);

  // ---- Act 3: Recovery ----
  log("ACT 3", "Simulating recovery: Circuit breaker cooldown expires");
  log("ACT 3", "Protocol resumes normal operation");

  console.log("");
  console.log("========================================================");
  console.log("  Simulation Complete!");
  console.log("  Check the dashboard at http://localhost:5173");
  console.log("========================================================");
  console.log("");
}

main().catch(console.error);
